<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A Caixa - Plano A</title>
    <link rel="stylesheet" href="/static/index/style/index.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
</head>
<body>
    <div id="lateralMenu">
        <div class="menu-part">
            <section class="menu-container1">
                <img src="/static/images/LOGO.png" alt="">
            </section>
            <div class="a-list-menu">
                <a href="">Como Jogar</a>
                <a href="">Trailer</a>
            </div>
            <div class="categories-element">
                <label>Categorias:</label>
            </div>
            <section class="menu-description">
                <div class="categories-container">
                    <div class="categories-element">
                        <span>4-6 Jogadores</span>
                    </div>
                    <div class="categories-element">
                        <span>Diversão</span>
                    </div>
                    <div class="categories-element">
                        <span>Curto</span>
                    </div>
                    <div class="categories-element">
                        <span>Desenho</span>
                    </div>
                </div>
            </section>
            <div class="categories-element">
                <label>Descrição:</label>
            </div>
            <section class="menu-description">
                <p>Plágio Consentido é sobre provar quem é o melhor plagiador em uma batalha épica contra seus amigos.</p>
            </section>
        </div>
        <div class="menu-part">
            <section class="button-container">
                <button onclick="joinRoom()" class="game-btn">Entrar em Sala</button>
                <button onclick="createRoom()" class="game-btn">Criar Sala</button>
            </section>
        </div>
        <!--<div class="menu-part1">
            <select name="" id="options">
                <option value="como_jogar">Como Jogar</option>
                <option value="trailer">Trailer</option>
            </select>
            <button>
                <img src="/static/images/index/go.svg" alt="">
            </button>
            <a id="videoThumbnail" href="https://youtube.com" class="menu-video-player"></a>
            <p>
                Plágio Consentido é sobre provar quem é o melhor plagiador em uma batalha épica contra seus amigos.
            </p>
        </div>
        <div class="menu-part2">
            <img src="/static/images/LOGO.png" alt="">
            <div class="sub-menu-part2">
                <div class="categories-container">
                    <div class="categories-element">
                        <span>4-6 Jogadores</span>
                    </div>
                    <div class="categories-element">
                        <span>Diversão</span>
                    </div>
                    <div class="categories-element">
                        <span>Curto</span>
                    </div>
                </div>
                <button onclick="joinRoom()" class="play-game-btn">Entrar em Sala</button>
                <button onclick="createRoom()" class="play-game-btn">Criar Sala</button>
            </div>-->
        </div>
    </div>
    <img id="logo" src="/static/images/index/planoA.png" alt="">
    <section id="inside">
        <div id="cardboardContainer">
            <div id="cardboardOpen"></div>
            <div id="PCGame"></div>
        </div>
        <footer>
            <a href="">Sobre</a>
            <a href="">Comunidade</a>
            <a href="">Redes Sociais</a>
            <a href="">Políticas</a>
        </footer>
    </section>

    <img id="fullscreen" src="fullscreen.svg" alt="">
    <div class="menu-inicial">
        <img id="cardboard" class="cardboard" src="/static/images/index/box.png" alt="">
        <div id="btnElement">
            <button onclick="abrirCaixa()" class="primary-btn">Abrir Caixa</button>
        </div>
    </div>
    <div id="errorContainer">
        <span id="errorMsg"></span>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        var socket = io({
            transports: ['websocket', 'polling']
        });

        let isCreatingRoom = false; // Rastreia se uma sala está sendo criada
        let socketId = null;

        socket.on('connect', function() {
            socketId = socket.id;
        });

        function joinRoom() {
            window.location.href = '/join'
        }

        function createRoom() {
            if (isCreatingRoom) return; // Evita múltiplos cliques
            isCreatingRoom = true; // Marca que o processo de criação está em andamento

            fetch('/create_room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'socket_id': socketId  // Passa o socket.id em vez de client_id
                })
            })
            .then(response => response.json())
            .then(data => {
                const errorMsg = document.getElementById('errorMsg');
                const errorContainer = document.getElementById('errorContainer');

                if (data.message === 'All rooms are full, you have been added to the queue') {
                    const queuePosition = data.queue_position;
                    errorMsg.innerText = `Todas as salas estão cheias. Você está na fila, posição: ${queuePosition}. Se você recarregar a página, perderá sua posição na fila.`;
                    errorContainer.classList.add('appear');
                    setTimeout(function() {
                        errorContainer.classList.remove('appear');
                    }, 4000);
                    listenForQueueUpdates(socketId); // Conecta ao socket para ouvir atualizações
                } 
                else if (data.room_id !== undefined) {
                    const roomId = data.room_id;
                    socket.disconnect()
                    window.location.href = `/host/${roomId}`;
                } 
                else {
                    console.error('Erro: Não foi possível criar a sala ou adicionar à fila');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            })
            .finally(() => {
                isCreatingRoom = false; // Restaura o estado após a tentativa de criação
            });
        }

        function listenForQueueUpdates(socketId) {
            socket.on('room_created', function(data) {
                if (data.socket_id === socketId) {
                    const roomId = data.room_id;
                    window.location.href = `/host/${roomId}`; // Redireciona para a sala
                }
            });
        }

        const fullscreenBtn = document.getElementById('fullscreen');

        fullscreenBtn.addEventListener('click', function() {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) { // Firefox
                document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullscreen) { // Chrome, Safari, Opera
                document.documentElement.webkitRequestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) { // IE/Edge
                document.documentElement.msRequestFullscreen();
            }
        });

/*        document.getElementById('options').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex].value;
            if (selectedOption === 'como_jogar') {
                document.getElementById('videoThumbnail').style.backgroundImage = 'url(/static/images/thumbnail1.png)'
            } else if (selectedOption === 'trailer') {
                console.log('Trailer');
            }
        });

        document.querySelector('.menu-video-player').addEventListener('mouseover', function() {
        //    document.querySelector('.menu-part1 button').style.display = 'block';
        });
        document.querySelector('.menu-video-player').addEventListener('mouseout', function() {
            document.querySelector('.menu-part1 button').style.display = 'none';
        });*/


        function abrirCaixa(){
            const cardboard = document.getElementById('cardboard')
            const cardboardContainer = document.getElementById('cardboardContainer')
            const btn = document.getElementById('btnElement')

            cardboard.classList.add('caindo')
            btn.classList.add('desappear')
            setTimeout(() => {
            cardboardContainer.classList.add('aparecendo')
            }, 2000);
        }

        function showGame(){
            const PCGame = document.getElementById('PCGame')
            const cardboardContainer = document.getElementById('cardboardContainer')
            const menu = document.getElementById('lateralMenu')
            const inactive = document.createElement('div')
            const body = document.body

            PCGame.addEventListener("click", function(){
                PCGame.classList.add('ativo')
                menu.classList.add('active')
                cardboardContainer.classList.add('menu-active')

                inactive.classList.add('inativo')
                body.appendChild(inactive)
            })

            inactive.addEventListener("click", function(){
                PCGame.classList.remove('ativo')
                menu.classList.remove('active')
                cardboardContainer.classList.remove('menu-active')

                body.removeChild(inactive)
            })
        }

        showGame()

    </script>
</body>
</html>